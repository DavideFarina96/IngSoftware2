<!DOCTYPE html>
<html>
  <head>
    <title>Orari Autobus</title>
    <meta name="viewport" content="initial-scale=1.0">
    <meta charset="utf-8">
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      /* valori da cambiare per la visualizzazione con webview
	  * i dati sono di test per simulare lo schermo del cellulare*/
	  #map {
        height: 80%;
		width: 25%;
		top: 10%;
		left: 20%;
      }
      /* Optional: Makes the sample page fill the window. */
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>
  <body onload="initMap()">
		<div id="map"></div>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
		<script>
		//dichiarazione mappa e finestra 
		var map, infoWindow;
		var service ;
		
		//google.maps.event.addDomListener(window, 'load', function(){initMap();});
		//funzione di inizializzazione richiamata col load della pagina
		function initMap() {
			map = new google.maps.Map(document.getElementById('map'), {
										mapTypeId: google.maps.MapTypeId.HYBRID,
										//center: {lat: -34.397, lng: 150.644},
										zoom: 15
									});
			
			
			infoWindow = new google.maps.InfoWindow;
			
			

			
			// Try HTML5 geolocation.
			//richiede la posizione al browser
			if (navigator.geolocation) {
				navigator.geolocation.getCurrentPosition(function(position) {
				var pos = {
					lat: position.coords.latitude,
					lng: position.coords.longitude
				};
				var testpos = {
					lat: 46.066910,
					lng: 11.150152
				};
				infoWindow.setPosition(pos); //inserire la posizione attuale con pos, testpos per povo
				infoWindow.setContent('You are here');
				infoWindow.open(map);
				map.setCenter(pos); //inserire la posizione attuale con pos, testpos per povo
				
				//creo una richiesta per la posizione delle fermate
					var request = {
						location: pos, //inserire la posizione attuale con pos, testpos per povo
						radius: 1000,
						types: ['train_station','bus_station','subway_station','transit_station']
					};
				service = new google.maps.places.PlacesService(map);
				//eseguo la richiesta asincrona(?)
				service.search(request, callback);
				getNextBuses(pos);
				//alert("Lat,Long: " + pos.lat + "," + pos.lng);
				}, function() {
					handleLocationError(true, infoWindow, map.getCenter());
				});
				
			}
			else {
				// Browser doesn't support Geolocation
				handleLocationError(false, infoWindow, map.getCenter());
			}
			
		}
		//posiziona i marker in ingresso (in questo caso le fermate) e inserisce la descrizione (personalizzabile)
		function createMarker(place) {
				
				
				var placeLoc = place.geometry.location;
				var marker = new google.maps.Marker({
				  map: map,
				  position: place.geometry.location
				});
				var content='<strong style="font-size:1.2em">'+place.name+'</strong>'+
							'<br/><strong>Type:</strong>'+place.types[0]+
							'<br/><strong>Rating:</strong>'+(place.rating||'n/a');
				var more_content='<img src="http://googleio2009-map.googlecode.com/svn-history/r2/trunk/app/images/loading.gif"/>';
				
				//make a request for further details
				service.getDetails({reference:place.reference}, function (place, status) 
					{
					  if (status == google.maps.places.PlacesServiceStatus.OK) 
					  {
						more_content='<hr/><strong><a href="'+place.url+'" target="details">Details</a>';
						
						if(place.website)
						{
						  more_content+='<br/><br/><strong><a href="'+place.website+'" target="details">'+place.website+'</a>';
						}
					  }
					});
				
					google.maps.event.addListener(marker, 'click', function() {
				  
					infoWindow.setContent(content+more_content);
					infoWindow.open(map, this);
				});
		}
		
		//quando riceve la risposta (le fermate) chiama la funzione che posiziona i marker
		function callback(results, status){
			if(status == google.maps.places.PlacesServiceStatus.OK){
				for (var i = 0; i<results.length; i++){
					createMarker(results[i]);
					
				}
			}
		}
		//messaggio di errore se non trova la posizione
		function handleLocationError(browserHasGeolocation, infoWindow, pos) {
			infoWindow.setPosition(pos);
			infoWindow.setContent(browserHasGeolocation ?
								  'Error: The Geolocation service failed.' :
								  'Error: Your browser doesn\'t support geolocation.');
			infoWindow.open(map);
		}
		
		//funzione che richiede alle api di maps indicazioni per raggiungere un posto in input
		//e restituisce l'orario di partenza del prossimo autobus da ogni fermata nel raggio
		function getNextBuses (stops){
			var url = "https://maps.googleapis.com/maps/api/directions/json?origin=Povo&destination=Trento-Autostaz.&alternative=true&transit_mode=train|tram|bus&mode=transit&key=AIzaSyBm3HQcIrjGyQAjRemBa9HZjrbp2l0uMCc";
			
			/*var xmlhttp = new XMLHttpRequest();
			

			xmlhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					var myArr = JSON.parse(this.responseText);
					console.log(myArr);
				}
			};
			xmlhttp.open("GET", url, true);
			xmlhttp.send();*/

			$.ajaxPrefilter( function (options) {
			  if (options.crossDomain && jQuery.support.cors) {
				var http = (window.location.protocol === 'http:' ? 'http:' : 'https:');
				options.url = http + '//cors-anywhere.herokuapp.com/' + options.url;
				//options.url = "http://cors.corsproxy.io/url=" + options.url;
			  }
			});
			var data;
			$.ajax({
				crossOrigin: true,
				url: url,
				success: function(data) {
					handleDirections(data);
				}
			});
			function handleDirections(data){
				console.log(data);
				console.log("next bus is: "+data.routes[0].legs[0].departure_time.text + " from: ");
			}
			/*var data;
			$.ajax({
				dataType: "json",
				url: 				data: data,
				success: success
			});
			function success(result){
				console.log($.parseJSON(results));
				console.log(result);
			}
			alert (data);
			$.getJSON( "ajax/test.json", function( data ) {
				var items = [];
				$.each( data, function( key, val ) {
					items.push( "<li id='" + key + "'>" + val + "</li>" );
				});
			 
				$( "<ul/>", {
				"class": "my-new-list",
				html: items.join( "" )
				}).appendTo( "body" );
			});*/ 
		}
		</script>
		<!-- libreria per la ricerca di luoghi speciali-->
		
		<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBm3HQcIrjGyQAjRemBa9HZjrbp2l0uMCc&libraries=places"
		async defer></script>
	</body>
</html>
<!-- ES completo: https://maps.googleapis.com/maps/api/directions/json?origin=LevicoTerme&destination=Trento&alternative=true&transit_mode=train|tram|bus&mode=transit&key=AIzaSyBm3HQcIrjGyQAjRemBa9HZjrbp2l0uMCc&callback=initMap& -->